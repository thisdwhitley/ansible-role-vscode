---
- hosts: all

  pre_tasks:
    - name: Update apt cache
      apt: update_cache=yes cache_valid_time=300
      when: ansible_os_family == 'Debian'

    - name: Ensure build dependencies are installed (RedHat)
      package: name=which state=present
      when: ansible_os_family == 'RedHat'

    - name: create test users
      become: yes
      user:
        name: '{{ item }}'
        state: present
        home: '/home/{{ item }}'
        createhome: yes
      with_items:
        - test_user1
        - test_user2
        - test_user3

  roles:
    - role: role_under_test
      users:
        - username: test_user1
          vscode_extensions:
            - streetsidesoftware.code-spell-checker
            - wholroyd.jinja
            - donjayamanne.python
          vscode_settings: {
            "editor.rulers": [80, 100, 120],
            "editor.renderWhitespace": true,
            "files.associations": {
              "Vagrantfile": "ruby"
            }
          }
        - username: test_user2
          vscode_extensions: []
          vscode_settings: {}
        - username: test_user3